% commutative diagrams
\usepackage{tikz}
\usetikzlibrary{cd}

\usepackage{xspace}
\usepackage[all]{foreign}
%\newcommand*{\eg}{e.g.\@\xspace}
%\newcommand*{\ie}{i.e.\@\xspace}
%\newcommand*{\etc}{etc.\@\xspace}
\newcommand*{\linearEGV}{\ensuremath{\text{EGV}_{\!\text{L}}}\xspace}
\newcommand*{\affineEGV}{\ensuremath{\text{EGV}_{\!\text{A}}}\xspace}
\newcommand*{\affineAGV}{\ensuremath{\text{AGV}_{\!\text{A}}}\xspace}

\usepackage{cmll}
\usepackage{setspace}
\usepackage{stmaryrd}
\usepackage{mdframed}
\usepackage{mathtools}
\usepackage{bussproofs}
\EnableBpAbbreviations
\newenvironment{prooftree*}{\leavevmode\hbox\bgroup}{\DisplayProof\egroup}

\usepackage{xcolor}
\definecolor{stcolor}{HTML}{000000}
\definecolor{tmcolor}{HTML}{4791d4}
\definecolor{tycolor}{HTML}{ce537a}
\let\tm\relax
\let\ty\relax
\let\st\relax
\newenvironment{highlight}
	{\ignorespaces%
	 \def\tm##1{\textcolor{tmcolor}{##1}}%
	 \def\ty##1{\textcolor{tycolor}{##1}}%
	 \def\st##1{\textcolor{stcolor}{##1}}}%
	{\let\tm\relax%
	 \let\ty\relax%
	 \let\st\relax%
	 \ignorespacesafterend}
\newcommand{\hl}[1]{\highlight#1\endhighlight}


\newcommand{\tmty}[2]{\tm{#1}:\ty{#2}}
\newcommand{\gvSeq}[3]{#1\vdash\tmty{#2}{#3}}
\newcommand{\gvCSeq}[4]{#1\st{;}\;#2\;{\vdash}^{#3}\;\tm{#4}}
\newcommand{\rvSeq}[3]{\gvSeq{\texttt{\ensuremath{#1}}}{\rvTm{#2}}{\rvTy{#3}}}
\newcommand{\rvCSeq}[3]{#1\;\st{\vdash}^{#2}\;\rvTm{#3}}
\newcommand{\rvHSeq}[3]{#1\st{;}\;#2\;\st{\vdash}\;\tm{#3}}
\newcommand{\sep}[0]{\;\mid\;}

\newcommand{\header}[2]{%
\parbox{0.5\textwidth}{#1}%
\parbox{0.5\textwidth}{\raggedleft\boxed{#2}}}

\newcommand{\lta}[1]{\ensuremath{\st{{\downarrow}_{\text{A}}}\tm{#1}}}
\newcommand{\atl}[1]{\ensuremath{\st{{\uparrow}_{\text{A}}}\tm{#1}}}
\newcommand{\atm}[1]{\ensuremath{\st{{\downarrow}_{\mathbf{opt}}}\tm{#1}}}
\newcommand{\atmTy}[2][]{\ensuremath{%
    \colorlet{tmp}{.}\color{stcolor}\left\llbracket\color{tmp}#2%
    \colorlet{tmp}{.}\color{stcolor}\right\rrbracket_{\!#1}\color{tmp}}}
\newcommand{\atv}[1]{\ensuremath{\st{{\downarrow}_{\mathbf{val}}}\tm{#1}}}
\newcommand{\mta}[1]{\ensuremath{\st{{\uparrow}_{\mathbf{opt}}}\tm{#1}}}
\newcommand{\mte}[1]{\ensuremath{\st{{\downarrow}_{\ell}}\tm{#1}}}
\newcommand{\etm}[1]{\ensuremath{\st{{\uparrow}_{\ell}}\tm{#1}}}
\newcommand{\mtr}[1]{\ensuremath{\st{{\downarrow}_{\texttt{RV}}}\tm{#1}}}
\newcommand{\mtrh}[2][]{\ensuremath{\st{{\downarrow}^{#1}_{\texttt{H}}}\tm{#2}}}
\newcommand{\mtrc}[1]{\ensuremath{\st{{\downarrow}_{\texttt{C}}}\tm{#1}}}
\newcommand{\rtm}[1]{\ensuremath{\st{{\uparrow}_{\texttt{RV}}}\tm{#1}}}

\newcommand{\ftm}[2][]{\ensuremath{%
    \colorlet{tmp}{.}\color{stcolor}\left\llbracket\color{tmp}#2%
    \colorlet{tmp}{.}\color{stcolor}\right\rrbracket_{\!#1}\color{tmp}}}
\newcommand{\ftmc}[1]{\ensuremath{\ftm{#1}_{\!\scriptscriptstyle\st{\mathcal{C}}}}}
\newcommand{\ftmh}[1]{\ensuremath{\ftm{#1}_{\!\scriptscriptstyle\st{\mathcal{H}}}}}

% GV syntax

\newcommand{\parens}[1]{\st{(}#1\st{)}}
\newcommand{\gvTyUnit}[0]{\st{\mathbf{1}}}
\newcommand{\gvTyFun}[2]{\ty{#1}\mathbin{\st{\multimap}}\ty{#2}}
\newcommand{\gvTySum}[2]{\ty{#1}\mathbin{\st{+}}\ty{#2}}
\newcommand{\gvTyOpt}[1]{\st{\mathbf{opt}}\,\ty{#1}}
\newcommand{\gvTyPair}[2]{\ty{#1}\mathbin{\st{\times}}\ty{#2}}

\newcommand{\gvTySend}[2]{\st{!}\ty{#1}\st{.}\ty{#2}}
\newcommand{\gvTyRecv}[2]{\st{?}\ty{#1}\st{.}\ty{#2}}
\newcommand{\gvTyEnd}[0]{\st{\mathbf{end}}}
\newcommand{\gvDual}[1]{%
    \colorlet{tmp}{.}\color{stcolor}\overline{\color{tmp}\ty{#1}\color{tmp}}}
\newcommand{\gvTyLock}[1]{\ty{#1}^{\st{\#}}}

\newcommand{\emptyenv}[0]{\cdot}

\newcommand{\gvDo}[3]{\ensuremath{%
    \st{\textbf{let}}\;\tm{#1}\;\st{=}\;\tm{#2}\st{?;}\;\tm{#3}}}
\newcommand{\gvDoDef}[3]{\gvCaseOpt{#2}{#1}{#3}{\gvNone}}


\newcommand{\gvVar}[1]{\tm{#1}}
\newcommand{\gvAbs}[3][]{\ensuremath{%
    \st{\lambda}\tm{#2}^{\ty{#1}}\st{.}\tm{#3}}}
\newcommand{\gvApp}[2]{\ensuremath{%
    \tm{#1}\;\tm{#2}}}
\newcommand{\gvUnit}[0]{\ensuremath{\st{()}}}
\newcommand{\gvLetUnit}[2]{\ensuremath{%
    \st{\mathbf{let}}\;\gvUnit\;\st{=}\;\tm{#1}\;\st{\mathbf{in}}\;\tm{#2}}}
\newcommand{\gvPair}[2]{\ensuremath{
    \st{(}\tm{#1}\st{,}\;\tm{#2}\st{)}}}
\newcommand{\gvLetPair}[4]{\ensuremath{%
    \st{\mathbf{let}}\;\gvPair{#1}{#2}\;\st{=}\;\tm{#3}\;\st{\mathbf{in}}\;\tm{#4}}}
\newcommand{\gvInl}[1]{\ensuremath{\st{\mathbf{inl}}\;\tm{#1}}}
\newcommand{\gvInr}[1]{\ensuremath{\st{\mathbf{inr}}\;\tm{#1}}}
\newcommand{\gvCaseSum}[5]{\ensuremath{%
    \st{\mathbf{case}}\;\tm{#1}\;\st{\{}%
    \gvInl{#2}\mathbin{\st{\mapsto}}\tm{#3}\st{;}\;%
    \gvInr{#4}\mathbin{\st{\mapsto}}\tm{#5}\st{\}}}}
\newcommand{\gvSome}[1]{\ensuremath{\st{\mathbf{some}}\;\tm{#1}}}
\newcommand{\gvNone}[0]{\ensuremath{\st{\mathbf{none}}}}
\newcommand{\gvCaseOpt}[4]{\ensuremath{%
    \st{\mathbf{case}}\;\tm{#1}\;\st{\{}%
    \gvSome{#2}\mathbin{\st{\mapsto}}\tm{#3}\st{;}\;%
    \gvNone\mathbin{\st{\mapsto}}\tm{#4}\st{\}}}}
\newcommand{\gvFork}[1]{\ensuremath{%
    \gvApp{\st{\mathbf{fork}}}{\tm{#1}}}}
\newcommand{\gvSend}[2]{\ensuremath{%
    \gvApp{\gvApp{\st{\mathbf{send}}}{\tm{#1}}}{\tm{#2}}}}
\newcommand{\gvRecv}[1]{\ensuremath{%
    \gvApp{\st{\mathbf{recv}}}{#1}}}
\newcommand{\gvClose}[1]{\ensuremath{%
    \gvApp{\st{\mathbf{close}}}{#1}}}
\newcommand{\gvCancel}[1]{\ensuremath{%
    \gvApp{\st{\mathbf{cancel}}}}{#1}}
\newcommand{\gvRaise}[0]{\ensuremath{%
    \st{\mathbf{raise}}}}
\newcommand{\gvTry}[4]{\ensuremath{%
    \st{\mathbf{try}}\;\tm{#1}\;\st{\mathbf{as}}\;\tm{#2}\;%
    \st{\mathbf{in}}\;\tm{#3}\;\st{\mathbf{otherwise}}\;\tm{#4}}}

\newcommand{\gvFlagMain}[0]{\ensuremath{\st{\bullet}}}
\newcommand{\gvFlagChild}[0]{\ensuremath{\st{\circ}}}
\newcommand{\gvThread}[2]{\ensuremath{\tm{#1}\tm{#2}}}
\newcommand{\gvMain}[1]{\ensuremath{\gvThread{\gvFlagMain}{#1}}}
\newcommand{\gvChild}[1]{\ensuremath{\gvThread{\gvFlagChild}{#1}}}
\newcommand{\gvRes}[2]{\ensuremath{\st{(}\st{\nu}\tm{#1}\st{)}\,\tm{#2}}}
\newcommand{\gvPar}[2]{\ensuremath{\tm{#1}\;\st{\parallel}\;\tm{#2}}}
\newcommand{\gvPPar}[2]{\ensuremath{\st{(}\gvPar{#1}{#2}\st{)}}}
\newcommand{\gvHalt}[0]{\ensuremath{\st{\mathbf{halt}}}}
\newcommand{\gvZap}[1]{\ensuremath{\st{\lightning}\tm{#1}}}
\newcommand{\gvBuf}[4]{\ensuremath{\tm{#1}\st{(}\tm{#2}\st{)}\st{\leftrightsquigarrow}\tm{#3}\st{(}\tm{#4}\st{)}}}
\newcommand{\gvHole}[0]{\ensuremath{[]}}
\newcommand{\gvVecAdd}[0]{\ensuremath{\,\st{\cdot}\,}}
\newcommand{\gvVecEmp}[0]{\ensuremath{\st{\epsilon}}}
\newcommand{\gvVec}[1]{%
    \colorlet{tmp}{.}\color{stcolor}\vec{\color{tmp}\tm{#1}\color{tmp}}}
\newcommand{\gvTyVec}[1]{%
    \colorlet{tmp}{.}\color{stcolor}\vec{\color{tmp}\ty{#1}\color{tmp}}}
\newcommand{\gvSlice}[2]{\ty{#1}\st{/}\ty{#2}}

\newcommand{\ren}[1]{\ensuremath{\st{\rho}_{\scriptstyle#1}}}
\newcommand{\zap}[1]{\ensuremath{\st{\zeta}_{\scriptstyle#1}}}

\newcommand{\gvConf}[1]{\ensuremath{\tm{\mathcal{#1}}}}

\newcommand{\gvPlug}[2]{\ensuremath{\tm{#1}\st{[}\tm{#2}\st{]}}}
\newcommand{\gvSub}[3]{\ensuremath{\tm{#1}\st{\{}\tm{#3}\st{/}\tm{#2}\st{\}}}}
\newcommand{\gvRedArr}[0]{\mathrel{\st{\longrightarrow}}}
\newcommand{\gvRed}[2]{\ensuremath{\tm{#1}\gvRedArr\tm{#2}}}
\newcommand{\gvRedArrPure}[0]{\mathrel{\st{\longrightarrow_{M}}}}
\newcommand{\gvRedPure}[2]{\ensuremath{\tm{#1}\gvRedArrPure\tm{#2}}}
\newcommand{\gvArc}[2]{\ensuremath{\st{\text{rc}}\st{(}\tm{#1}\st{,}\;\tm{#2}\st{)}}}

% RV syntax

\newcommand{\rvTy}[1]{\texttt{\ty{#1}}}
\newcommand{\rvTm}[1]{\texttt{\tm{#1}}}
\newcommand{\rvSt}[1]{\texttt{\st{#1}}}

\newcommand{\rvTyUnit}[0]{\texttt{\st{()}}}
\newcommand{\rvTyFun}[2]{\texttt{\ty{FnOnce}\st{(}\ty{#1}\st{)}\;\st{$\rightarrow$}\;\ty{#2}}}
\newcommand{\rvTySum}[2]{\texttt{\ty{Either}\st{<}\ty{#1}\st{,}\;\ty{#2}\st{>}}}
\newcommand{\rvTyPair}[2]{\texttt{\st{(}\ty{#1}\st{,}\;\ty{#2}\st{)}}}
\newcommand{\rvTyOpt}[1]{\texttt{\ty{Option}\st{<}\ty{#1}\st{>}}}

\newcommand{\rvTySend}[2]{\texttt{\ty{Send}\st{<}\ty{#1}\st{,}\;\ty{#2}\st{>}}}
\newcommand{\rvTyRecv}[2]{\texttt{\ty{Recv}\st{<}\ty{#1}\st{,}\;\ty{#2}\st{>}}}
\newcommand{\rvTyEnd}[0]{\texttt{\ty{End}}}
\newcommand{\rvDual}[1]{\texttt{\ty{#1}\st{:\!:}\ty{Dual}}}

\newcommand{\rvAbs}[3][]{\texttt{%
    \st{\textbf{move}}\;\st{{|}}\tm{#2}\st{:}\ty{#1}\st{{|}}\;\st{\{}\;\tm{#3}\;\st{\}}}}
\newcommand{\rvApp}[2]{\texttt{\tm{#1}\st{(}\tm{#2}\st{)}}}
\newcommand{\rvUnit}[0]{\texttt{\st{()}}}
\newcommand{\rvLetUnit}[2]{\texttt{%
    \st{\textbf{let}}\;\rvUnit\;\st{=}\;\tm{#1}\st{;}\;\tm{#2}}}
\newcommand{\rvPair}[2]{\texttt{\st{(}\tm{#1}\st{,}\;\tm{#2}\st{)}}}
\newcommand{\rvLetPair}[4]{\texttt{%
    \st{\textbf{let}}\;\rvPair{#1}{#2}\;\st{=}\;\tm{#3}\st{;}\;\tm{#4}}}
\newcommand{\rvInl}[1]{\texttt{\rvApp{\st{Left}}{#1}}}
\newcommand{\rvInr}[1]{\texttt{\rvApp{\st{Right}}{#1}}}
\newcommand{\rvCaseSum}[5]{\texttt{%
    \st{\textbf{match}}\;\tm{#1}\;\st{\{}\;%
    \rvInl{#2}\;\st{$\Rightarrow$}\;\tm{#3}\st{,}\;%
    \rvInr{#4}\;\st{$\Rightarrow$}\;\tm{#5}\;\st{\}}}}
\newcommand{\rvFork}[1]{\rvApp{\st{{fork}}}{#1}}
\newcommand{\rvSend}[2]{\rvApp{\st{{send}}}{#1\st{,}\;#2}}
\newcommand{\rvRecv}[1]{\rvApp{\st{{recv}}}{#1}}
\newcommand{\rvClose}[1]{\rvApp{\st{close}}{#1}}
\newcommand{\rvSome}[1]{\rvApp{\st{Some}}{#1}}
\newcommand{\rvNone}[0]{\texttt{\st{None}}}
\newcommand{\rvCaseOpt}[4]{\texttt{%
    \st{\textbf{match}}\;\tm{#1}\;\st{\{}\;%
    \rvSome{#2}\;\st{$\Rightarrow$}\;\tm{#3}\st{,}\;%
    \rvNone{}\;\st{$\Rightarrow$}\;\tm{#4}\;\st{\}}}}

\newcommand{\rvDo}[3]{\texttt{%
    \st{\textbf{let}}\;\tm{#1}\;\st{=}\;\tm{#2}\st{?;}\;\tm{#3}}}
\newcommand{\rvDoDef}[3]{\rvCaseOpt{#2}{#1}{#3}{\rvNone}}

\newcommand{\rvFlagMain}[0]{\ensuremath{\st{\bullet}}}
\newcommand{\rvFlagChild}[0]{\ensuremath{\st{\circ}}}
\newcommand{\rvThread}[2]{\ensuremath{\tm{#1}\,\tm{#2}}}
\newcommand{\rvMain}[1]{\ensuremath{\rvThread{\rvFlagMain}{#1}}}
\newcommand{\rvChild}[1]{\ensuremath{\rvThread{\rvFlagChild}{#1}}}
\newcommand{\rvPanic}[0]{\rvApp{\st{panic!\!}}{}}

\newcommand{\rvHole}[0]{\ensuremath{[]}}

\newcommand{\rvConf}[1]{\ensuremath{\tm{\mathcal{#1}}}}

\newcommand{\rvHeap}[1]{\ensuremath{\mathcal{#1}}}
\newcommand{\rvHeapEmp}[0]{\ensuremath{\varnothing}}
\newcommand{\rvHeapData}[4]{%
    \tm{#1}\st{,}\;\st{\{}\tm{#2}\st{,}\,\tm{#3}\st{\}}\;\st{\mapsto}\;\tm{#4}}
\newcommand{\rvHeapDisc}[3]{%
    \tm{#1}\st{,}\;\st{\{}\tm{#2}\st{,}\,\tm{#3}\st{\}}\;\st{\mapsto}\;\rvMemDisc}

\newcommand{\rvArc}[3]{\rvApp{\st{arc}}{\tm{#1}\st{,}\;\st{$\langle$}\tm{#2}\st{,}\;\tm{#3}\st{$\rangle$}}}
\newcommand{\ftmArc}[2]{\rvApp{\st{arc}}{$\ren{#2}\st{(}\tm{#1}\st{)}$\st{,}\;\ftm{#2}}}

\newcommand{\rvMem}[1]{\ensuremath{\mathcal{#1}}}
\newcommand{\rvMemEmp}[0]{\texttt{\st{EMPTY}}}
\newcommand{\rvMemData}[2]{\rvApp{\st{DATA}}{\tm{#1}\st{,}\;\tm{#2}}}
\newcommand{\rvMemDisc}[0]{\texttt{\st{DISCONNECTED}}}

\newcommand{\rvPlug}[2]{\texttt{\tm{#1}\st{[}\tm{#2}\st{]}}}
\newcommand{\rvSub}[3]{\texttt{\tm{#1}\st{\{}\tm{#3}\st{/}\tm{#2}\st{\}}}}
\newcommand{\rvRedTup}[3][\rvConf{C}]{%
    \st{\langle}\tm{#2}\parallel\tm{#1}\if\relax\detokenize{#3}\else\st{,}\;\fi\tm{#3}\st{\rangle}}
\newcommand{\rvRedArr}[0]{\mathrel{\st{\longrightarrow}}}
\newcommand{\rvRed}[5][\rvConf{C}]{\rvRedTup[#1]{#2}{#3}\rvRedArr\rvRedTup[#1]{#4}{#5}}
\newcommand{\rvRedArrPure}[0]{\mathrel{\st{\longrightarrow_{M}}}}
\newcommand{\rvRedPure}[2]{\texttt{\tm{#1}}\rvRedArrPure\texttt{\tm{#2}}}

%%% cleveref and custom labels

\usepackage{hyperref}
\usepackage{nameref}
\usepackage[capitalise,nameinlink,noabbrev]{cleveref}

\makeatletter
\newcommand{\customlabel}[4][0]{%
	\protected@write\@auxout{}{\string\newlabel{#3}{{#4}{\thepage}{#4}{#3}{}}}%
	\protected@write\@auxout{}{\string\newlabel{#3@cref}{{[#2][#1][#1]#4}{\thepage}}}%
}
\newcommand{\phantomlabel}[4][0]{%
	\customlabel[#1]{#2}{#3}{#4}%
	\hypertarget{#3}{}%
}
\newcommand{\crefv}[1]{%
	\begingroup\@cref@compressfalse\@cref@sortfalse\cref{#1}\endgroup%
}
\newcommand{\Crefv}[1]{%
	\begingroup\@cref@compressfalse\@cref@sortfalse\Cref{#1}\endgroup%
}
\newcommand{\crefabbrev}[1]{%
	\begingroup\@cref@abbrevtrue\cref{#1}\endgroup%
}
\makeatother

\newcommand{\rlabel}[2]{{%
	\customlabel{infrule}{#2}{#1}%
	\hypertarget{#2}{#1}}}
\crefname{infrule}{rule}{rules}
\Crefname{infrule}{Rule}{Rules}