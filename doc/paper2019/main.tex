\documentclass[sigplan,screen,review]{acmart}
\title{Rusty Variation}
\subtitle{Session Types with Failure for Rust}
\author{Wen Kokke}
\orcid{0000-0002-1662-0381}
\affiliation{
  \department{Laboratory for Foundations of Computer Science}
  \institution{University of Edinburgh}
  \streetaddress{10 Crichton Street}
  \city{Edinburgh}
  \state{Scotland}
  \postcode{EH8 9AB}
  \country{United Kingdom}
}
\email{wen.kokke@ed.ac.uk}
\setcopyright{none}
\settopmatter{printccs=false, printacmref=false, printfolios=false}

\input{preamble}

\begin{document}
\maketitle


\section{Rusty Variation}

\begin{figure*}
  \begin{mdframed}
    \[
    \begin{array}{llrl}
      \text{Types}
      &\ty{A}, \ty{B}, \ty{C}
      &::=& \rvTyUnit
            \mid \rvTyFun{A}{B}
            \mid \rvTySum{A}{B}
            \mid \rvTyPair{A}{B}
            \mid \rvTyOpt{A}
            \mid \texttt{\ty{S}}
      \\
      \text{Session types}
      &\ty{S}, \ty{T}
      &::=& \rvTySend{A}{S}
            \mid \rvTyRecv{A}{S}
            \mid \rvTyEnd
      \\
      \text{Terms}
      &\tm{L}, \tm{M}, \tm{N}
      &::=& \rvVar{x}
            \mid \rvAbs[A]{x}{M}
            \mid \rvApp{M}{N}
      \\
      &
      &\mid& \rvUnit
             \mid \rvLetUnit{M}{N}
      \\
      &
      &\mid& \rvPair{M}{N}
             \mid \rvLetPair{x}{y}{M}{N}
      \\
      &
      &\mid& \rvInl{M}
             \mid \rvInr{M}
             \mid \rvCaseSum{L}{x}{M}{x}{N}
      \\
      &
      &\mid& \rvSome{M}
             \mid \rvNone
             \mid \rvCaseOpt{L}{x}{M}{N}
      \\
      &
      &\mid& \rvFork{M}
             \mid \rvSend{M}{N}
             \mid \rvRecv{M}
    \end{array}
    \]
  \end{mdframed}
  \caption{Rusty Variation, terms and types.}
  \label{fig:rv}
\end{figure*}

\begin{figure*}
  \begin{mdframed}
    \[
    \begin{array}{lcl}
      \rvTry{x}{M}{N} &::=& \rvTryDef{x}{M}{N}
      \\
      \rvTry{\rvUnit}{M}{N} &::=& \rvTryDef{x}{M}{\rvLetUnit{x}{N}}
      \\
      \rvTry{\rvPair{x}{y}}{M}{N} &::=& \rvTryDef{z}{M}{\rvLetPair{x}{y}{z}{N}}
    \end{array}
    \]
  \end{mdframed}
  \caption{Rusty Variation, the \texttt{try!} macro.}
  \label{fig:rv-try}
\end{figure*}

\begin{figure*}
  \begin{mdframed}
    \centering
    \setstretch{2.5}

    \begin{prooftree*}
      \AXC{$\tmty{x}{A}\in\ty{\Gamma}$}
      \RightLabel{\textsc{T-Var}}
      \UIC{$\seq{\ty{\Gamma}}{\rvVar{x}}{A}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}\st{,}\;\ty{A}}{M}{B}$}
      \RightLabel{\textsc{T-Abs}}
      \UIC{$\seq{\ty{\Gamma}}{\rvAbs[A]{x}{M}}{\rvTyFun{A}{B}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\rvTyFun{A}{B}}$}
      \AXC{$\seq{\ty{\Delta}}{N}{A}$}
      \RightLabel{\textsc{T-App}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\rvApp{M}{N}}{B}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{}
      \RightLabel{\textsc{T-Unit}}
      \UIC{$\seq{\ty{\Gamma}}{\rvUnit}{\rvTyUnit}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\rvTyUnit}$}
      \AXC{$\seq{\ty{\Delta}}{N}{A}$}
      \RightLabel{\textsc{T-LetUnit}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\rvLetUnit{M}{N}}{A}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \AXC{$\seq{\ty{\Delta}}{N}{B}$}
      \RightLabel{\textsc{T-Pair}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\rvPair{M}{N}}{\rvTyPair{A}{B}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\rvTyPair{A}{B}}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{x}{A}\st{,}\;\tmty{y}{B}}{N}{C}$}
      \RightLabel{\textsc{T-LetPair}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\rvLetPair{x}{y}{M}{N}}{C}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \RightLabel{\textsc{T-Left}}
      \UIC{$\seq{\ty{\Gamma}}{\rvInl{M}}{\rvTySum{A}{B}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{B}$}
      \RightLabel{\textsc{T-Right}}
      \UIC{$\seq{\ty{\Gamma}}{\rvInr{M}}{\rvTySum{A}{B}}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{L}{\rvTySum{A}{B}}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{x}{A}}{M}{C}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{y}{B}}{N}{C}$}
      \RightLabel{\textsc{T-CaseSum}}
      \TIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\rvCaseSum{L}{x}{M}{y}{N}}{C}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \RightLabel{\textsc{T-Some}}
      \UIC{$\seq{\ty{\Gamma}}{\rvSome{M}}{\rvTyOpt{A}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{}
      \RightLabel{\textsc{T-None}}
      \UIC{$\seq{\ty{\Gamma}}{\rvNone}{\rvTyOpt{A}}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{L}{\rvTyOpt{A}}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{x}{A}}{M}{C}$}
      \AXC{$\seq{\ty{\Delta}}{N}{C}$}
      \RightLabel{\textsc{T-CaseOpt}}
      \TIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\rvCaseOpt{L}{x}{M}{N}}{C}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\rvTyFun{S}{\rvTyOpt{\rvTyUnit}}}$}
      \RightLabel{\textsc{T-Fork}}
      \UIC{$\seq{\ty{\Gamma}}{\rvFork{M}}{\rvDual{S}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\rvTyEnd}$}
      \RightLabel{\textsc{T-Close}}
      \UIC{$\seq{\ty{\Gamma}}{\rvClose{M}}{\rvTyOpt{\rvTyUnit}}$}
    \end{prooftree*}

    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \AXC{$\seq{\ty{\Delta}}{N}{\rvTySend{A}{S}}$}
      \RightLabel{\textsc{T-Send}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\rvSend{M}{N}}{S}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\rvTyRecv{A}{S}}$}
      \RightLabel{\textsc{T-Recv}}
      \UIC{$\seq{\ty{\Gamma}}{\rvRecv{M}}{\rvTyOpt{\rvPair{A}{S}}}$}
    \end{prooftree*}

    \(
      \rvDual{\rvTySend{A}{S}} = \rvTyRecv{A}{\rvDual{S}}
      \quad
      \rvDual{\rvTyRecv{A}{S}} = \rvTySend{A}{\rvDual{S}}
      \quad
      \rvDual{\rvTyEnd} = \rvTyEnd
    \)
  \end{mdframed}
\caption{Rusty Variation, typing rules.}
\label{fig:rv-typing}
\end{figure*}

\begin{figure*}
  \begin{mdframed}
    \centering
    \(
    \begin{array}{llrl}
      \text{Terms}
      &\tm{L}, \tm{M}, \tm{N}
      &::= & \dots
             \mid \tm{a}
      \\
      \text{Values}
      &\tm{U}, \tm{V}, \tm{W}
      &::= & \tm{a}
             \mid \rvAbs[A]{x}{M}
             \mid \rvUnit
             \mid \rvPair{V}{W}
             \mid \rvInl{V}
             \mid \rvInr{V}
      \\
      \text{Memory}
      &\tm{\rvMem{M}}
      &::= & \rvMemEmp
             \mid \rvMemData{V}{c}
      \\
      \text{Heaps}
      &\tm{\rvHeap{H}}
      &::= & \rvHeapEmp
             \mid \rvHeapData{\rvHeap{H}}{a}{\rvMem{M}}
             \mid \rvHeapDisc{\rvHeap{H}}{a}
      \\
      \text{Thread flags}
      &\tm{\phi}
      &::= & \rvFlagMain
             \mid \rvFlagChild
      \\
      \text{Threads}
      &\tm{T}
      &::= & \rvThread{\phi}{M}
             \mid \rvPanic
      \\
      \text{Evaluation contexts}
      &\tm{E}
      &::= & \rvHole
             \mid \rvApp{E}{M}
             \mid \rvApp{V}{E}
             \mid \rvLetUnit{E}{M}
             \mid \rvPair{E}{M}
             \mid \rvPair{V}{E}
             \mid \rvLetPair{x}{y}{E}{M}
      \\
      &
      &\mid& \rvInl{E}
             \mid \rvInr{E}
             \mid \rvCaseSum{E}{x}{M}{y}{N}
      \\
      &
      &\mid& \rvFork{E}
             \mid \rvSend{E}{M}
             \mid \rvSend{V}{E}
             \mid \rvRecv{E}
             \mid \rvClose{E}
      \\
      \text{Thread contexts}
      &\tm{F}
      &::= & \rvThread{\phi}{E}
    \end{array}
    \)
  \end{mdframed}
  \caption{Rusty Variation, runtime syntax.}
  \label{fig:rv-runtime}
\end{figure*}

\begin{figure*}
  \begin{mdframed}
    \centering
    \[\!\!%
      \setlength{\arraycolsep}{4pt}%
      \begin{array}{llcl}
        \textsc{E-Lam}
        & {\rvApp{\rvAbs[A]{x}{M}}{V}}
        & \rvRedArrPure
        & {\rvSub{M}{x}{V}}
        \\
        \textsc{E-Unit}
        & {\rvLetUnit{\rvUnit}{M}}
        & \rvRedArrPure
        & {\rvVar{M}}
        \\
        \textsc{E-Pair}
        & {\rvLetPair{x}{y}{\rvPair{V}{W}}{M}}
        & \rvRedArrPure
        & {\rvSub{M}{\tm{x}\st{,}\;\tm{y}}{\tm{V}\st{,}\;\tm{W}}}
        \\
        \textsc{E-Inl}
        & {\rvCaseSum{\rvInl{V}}{x}{M}{y}{N}}
        & \rvRedArrPure
        & {\rvSub{M}{x}{V}}
        \\
        \textsc{E-Inr}
        & {\rvCaseSum{\rvInr{V}}{x}{M}{y}{N}}
        & \rvRedArrPure
        & {\rvSub{N}{y}{V}}
        \\
        \textsc{E-Some}
        & {\rvCaseOpt{\rvSome{V}}{x}{M}{N}}
        & \rvRedArrPure
        & {\rvSub{M}{x}{V}}
        \\
        \textsc{E-None}
        & {\rvCaseOpt{\rvNone}{x}{M}{N}}
        & \rvRedArrPure
        & {\rvVar{N}}
        \\
        \textsc{E-Lift}
        & {\rvPlug{E}{M}}
        & \rvRedArrPure
        & {\rvPlug{E}{M'}}\st{,}
          \quad\text{if}\;\rvRedPure{M}{M'}
      \end{array}
    \]
    {
      \setstretch{2.0}
      \begin{prooftree}
        \AXC{\tm{a} is fresh}
        \RightLabel{\textsc{E-Fork}}
        \UIC{$
          \rvRedTup{\rvHeap{H}}{\rvPlug{F}{\rvFork{\rvAbs[S]{x}{M}}}}
          \rvRedArr
          \rvRedTup{\rvHeapData{\rvHeap{H}}{a}{\rvMemEmp}}{\rvPlug{F}{a}\st{,}\;\rvChild{\rvSub{M}{x}{a}}}$}
      \end{prooftree}
      \begin{prooftree}
        \AXC{\tm{b} is fresh}
        \RightLabel{E-Send}
        \UIC{$
          \rvRedTup{\rvHeapData{\rvHeap{H}}{a}{\rvMemEmp}}{\rvPlug{F}{\rvSend{U}{a}}}
          \rvRedArr
          \rvRedTup{\rvHeapData{\rvHeapData{\rvHeap{H}}{a}{\rvMemData{U}{b}}}{b}{\rvMemEmp}}{\rvPlug{F}{b}}$}
      \end{prooftree}
      \begin{prooftree}
        \AXC{}
        \RightLabel{\textsc{E-Recv}}
        \UIC{$
          \rvRedTup{\rvHeapData{\rvHeap{H}}{a}{\rvMemData{U}{b}}}{\rvPlug{F}{\rvRecv{a}}}
          \rvRedArr
          \rvRedTup{\rvHeap{H}}{\rvPlug{F}{\rvSome{\rvPair{U}{b}}}}$}
      \end{prooftree}
      \begin{prooftree}
        \AXC{}
        \RightLabel{\textsc{E-Close}}
        \UIC{$
          \rvRedTup
          {\rvHeapData{\rvHeap{H}}{a}{\rvMemEmp}}
          {\rvPlug{F}{\rvClose{a}}\st{,}\;\rvPlug{F'}{\rvClose{b}}}
          \rvRedArr
          \rvRedTup{\rvHeap{H}}{\rvPlug{F}{\rvSome{\rvUnit}}\st{,}\;\rvPlug{F'}{\rvSome{\rvUnit}}}$}
      \end{prooftree}
      \begin{center}
        \begin{prooftree*}
          \AXC{$\rvArc{a}{\rvHeap{H}}{\rvConf{C}}\le{1}$}
          \RightLabel{\textsc{E-Zap}}
          \UIC{$
            \rvRedTup[\rvConf{C}]{\rvHeapData{\rvHeap{H}}{a}{\rvMem{M}}}{}
            \rvRedArr
            \rvRedTup[\rvConf{C}]{\rvHeapDisc{\rvHeap{H}}{a}}{}$}
        \end{prooftree*}%
        \begin{prooftree*}
          \AXC{$\rvArc{a}{\rvHeap{H}}{\rvConf{C}}={0}$}
          \RightLabel{\textsc{E-GC}}
          \UIC{$
            \rvRedTup[\rvConf{C}]{\rvHeapDisc{\rvHeap{H}}{a}}{}
            \rvRedArr
            \rvRedTup[\rvConf{C}]{\rvHeap{H}}{}$}
        \end{prooftree*}
      \end{center}
      \begin{prooftree}
        \AXC{}
        \RightLabel{\textsc{E-CloseZap}}
        \UIC{$
          \rvRedTup{\rvHeapDisc{\rvHeap{H}}{a}}{\rvPlug{F}{\rvClose{a}}}
          \rvRedArr
          \rvRedTup{\rvHeapDisc{\rvHeap{H}}{a}}{\rvPlug{F}{\rvNone}}$}
      \end{prooftree}
      \begin{prooftree}
        \AXC{}
        \RightLabel{\textsc{E-RecvZap}}
        \UIC{$
          \rvRedTup{\rvHeapDisc{\rvHeap{H}}{a}}{\rvPlug{F}{\rvRecv{a}}}
          \rvRedArr
          \rvRedTup{\rvHeapDisc{\rvHeap{H}}{a}}{\rvPlug{F}{\rvNone}}$}
      \end{prooftree}
      \begin{center}
        \begin{prooftree*}
          \AXC{}
          \RightLabel{\textsc{E-HaltChild}}
          \UIC{$
            \rvRedTup[\rvConf{C}]{\rvHeap{H}}{\rvChild{\rvVar{V}}}
            \rvRedArr
            \rvRedTup[\rvConf{C}]{\rvHeap{H}}{}$}
        \end{prooftree*}%
        \begin{prooftree*}
          \AXC{}
          \RightLabel{\textsc{E-HaltMain}}
          \UIC{$
            \rvRedTup[\rvConf{C}]{\rvHeap{H}}{\rvMain{\rvNone}}
            \rvRedArr
            \rvRedTup[\rvConf{C}]{\rvHeap{H}}{\rvPanic}$}
        \end{prooftree*}
      \end{center}
      \begin{prooftree}
        \AXC{$\rvRedPure{M}{M'}$}
        \RightLabel{\textsc{E-LiftM}}
        \UIC{$
          \rvRedTup{\rvHeap{H}}{M}
          \rvRedArr
          \rvRedTup{\rvHeap{H}}{M'}$}
      \end{prooftree}
    }
  \end{mdframed}

  \caption{Rusty Variation, reduction semantics.}
  \label{fig:rv-reduction}
\end{figure*}


\section{Exceptional GV}

\begin{figure*}
  \begin{mdframed}
    \centering
    \(
    \begin{array}{llrl}
      \text{Types}
      &\ty{A}, \ty{B}, \ty{C}
      &::=& \gvTyUnit
            \mid \gvTyFun{A}{B}
            \mid \gvTySum{A}{B}
            \mid \gvTyPair{A}{B}
            \mid \ty{S}
      \\
      \text{Session types}
      &\ty{S}, \ty{T}
      &::=& \gvTySend{A}{S}
            \mid \gvTyRecv{A}{S}
            \mid \gvTyEnd
      \\
      \text{Terms}
      &\tm{L}, \tm{M}, \tm{N}
      &::=& \gvVar{x}
            \mid \gvAbs[A]{x}{M}
            \mid \gvApp{M}{N}
      \\
      &
      &\mid& \gvUnit
             \mid \gvLetUnit{M}{N}
      \\
      &
      &\mid& \gvPair{M}{N}
             \mid \gvLetPair{x}{y}{M}{N}
      \\
      &
      &\mid& \gvInl{M}
             \mid \gvInr{M}
             \mid \gvCaseSum{L}{x}{M}{y}{N}
      \\
      &
      &\mid& \gvRaise
             \mid \gvTry{L}{x}{M}{N}
      \\
      &
      &\mid&\gvFork{M}
             \mid \gvSend{M}{N}
             \mid \gvRecv{M}
             \mid \gvClose{M}
             \mid \gvCancel{M}
    \end{array}
    \)
  \end{mdframed}
  \caption{Exceptional GV, terms and types.}
  \label{fig:egv}
\end{figure*}

\begin{figure*}
  \begin{mdframed}
    \centering
    \setstretch{2.5}
    
    \begin{prooftree*}
      \AXC{}
      \RightLabel{\textsc{T-Var}}
      \UIC{$\seq{\tmty{x}{A}}{\gvVar{x}}{A}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}\st{,}\;\ty{A}}{M}{B}$}
      \RightLabel{\textsc{T-Abs}}
      \UIC{$\seq{\ty{\Gamma}}{\gvAbs[A]{x}{M}}{\gvTyFun{A}{B}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\gvTyFun{A}{B}}$}
      \AXC{$\seq{\ty{\Delta}}{N}{A}$}
      \RightLabel{\textsc{T-App}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\gvApp{M}{N}}{B}$}
    \end{prooftree*}
    
    \begin{prooftree*}
      \AXC{}
      \RightLabel{\textsc{T-Unit}}
      \UIC{$\seq{\emptyenv}{\gvUnit}{\gvTyUnit}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\gvTyUnit}$}
      \AXC{$\seq{\ty{\Delta}}{N}{A}$}
      \RightLabel{\textsc{T-LetUnit}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\gvLetUnit{M}{N}}{A}$}
    \end{prooftree*}
    
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \AXC{$\seq{\ty{\Delta}}{N}{B}$}
      \RightLabel{\textsc{T-Pair}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\gvPair{M}{N}}{\gvTyPair{A}{B}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\gvTyPair{A}{B}}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{x}{A}\st{,}\;\tmty{y}{B}}{N}{C}$}
      \RightLabel{\textsc{T-LetPair}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\gvLetPair{x}{y}{M}{N}}{C}$}
    \end{prooftree*}
    
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \RightLabel{\textsc{T-Left}}
      \UIC{$\seq{\ty{\Gamma}}{\gvInl{M}}{\gvTySum{A}{B}}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{B}$}
      \RightLabel{\textsc{T-Right}}
      \UIC{$\seq{\ty{\Gamma}}{\gvInr{M}}{\gvTySum{A}{B}}$}
    \end{prooftree*}
    
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{L}{\gvTySum{A}{B}}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{x}{A}}{M}{C}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{y}{B}}{N}{C}$}
      \RightLabel{\textsc{T-CaseSum}}
      \TIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\gvCaseSum{L}{x}{M}{y}{N}}{C}$}
    \end{prooftree*}
    
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \RightLabel{\textsc{T-Cancel}}
      \UIC{$\seq{\ty{\Gamma}}{\gvCancel{M}}{\gvUnit}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{L}{A}$}
      \AXC{$\seq{\ty{\Delta}\st{,}\;\tmty{x}{A}}{M}{B}$}
      \AXC{$\seq{\ty{\Gamma}}{N}{B}$}
      \RightLabel{\textsc{T-Try}}
      \TIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\gvTry{L}{x}{M}{N}}{B}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{}
      \RightLabel{\textsc{T-Raise}}
      \UIC{$\seq{\emptyenv}{\gvRaise}{A}$}
    \end{prooftree*}
    
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\gvTyFun{S}{\gvTyUnit}}$}
      \RightLabel{\textsc{T-Fork}}
      \UIC{$\seq{\ty{\Gamma}}{\gvFork{M}}{\gvDual{S}}$}
    \end{prooftree*}    
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\gvTyEnd}$}
      \RightLabel{\textsc{T-Close}}
      \UIC{$\seq{\ty{\Gamma}}{\gvClose{M}}{\gvUnit}$}
    \end{prooftree*}
    
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{A}$}
      \AXC{$\seq{\ty{\Delta}}{N}{\gvTySend{A}{S}}$}
      \RightLabel{\textsc{T-Send}}
      \BIC{$\seq{\ty{\Gamma}\st{,}\;\ty{\Delta}}{\gvSend{M}{N}}{S}$}
    \end{prooftree*}
    \begin{prooftree*}
      \AXC{$\seq{\ty{\Gamma}}{M}{\gvTyRecv{A}{S}}$}
      \RightLabel{\textsc{T-Recv}}
      \UIC{$\seq{\ty{\Gamma}}{\gvRecv{M}}{\gvPair{A}{S}}$}
    \end{prooftree*}
    
    \(
    \gvDual{\gvTySend{A}{S}}\;=\;\gvTyRecv{A}{\gvDual{S}}
    \quad
    \gvDual{\gvTyRecv{A}{S}}\;=\;\gvTySend{A}{\gvDual{S}}
    \quad
    \gvDual{\gvTyEnd}\;=\;\gvTyEnd
    \)
  \end{mdframed}
\caption{Exceptional GV, typing rules.}
\label{fig:gv-typing}
\end{figure*}

\begin{figure*}
  \begin{mdframed}
    \centering
    \(
    \begin{array}{llrl}
      \text{Terms}
      &\tm{L}, \tm{M}, \tm{N}
      &::= & \dots
             \mid \tm{a}
      \\
      \text{Values}
      &\tm{U}, \tm{V}, \tm{W}
      &::= & \tm{a}
             \mid \gvAbs[A]{x}{M}
             \mid \gvUnit
             \mid \gvPair{V}{W}
             \mid \gvInl{V}
             \mid \gvInr{V}
      \\
      \text{Flags}
      &\tm{\phi}
      &::= & \gvFlagMain \mid \gvFlagChild
      \\
      \text{Configurations}
      &\tm{\gvConf{C}}, \tm{\gvConf{D}}, \tm{\gvConf{E}}
      &::= & \tm{\phi}\tm{M}
             \mid \gvRes{a}{\gvConf{C}}
             \mid \gvPPar{\gvConf{C}}{\gvConf{D}}
             \mid \gvHalt
             \mid \gvZap{a}
             \mid \gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}
      \\
      \text{Evaluation contexts}
      &\tm{E}
      &::= & \gvHole
             \mid \gvApp{E}{M}
             \mid \gvApp{V}{E}
             \mid \gvLetUnit{E}{M}
             \mid \gvPair{E}{M}
             \mid \gvPair{V}{E}
             \mid \gvLetPair{x}{y}{E}{M}
      \\
      &
      &\mid& \gvInl{E}
             \mid \gvInr{E}
             \mid \gvCaseSum{E}{x}{M}{y}{N}
      \\
      &
      &\mid& \gvFork{E}
             \mid \gvSend{E}{M}
             \mid \gvSend{V}{E}
             \mid \gvRecv{E}
             \mid \gvClose{E}
             \mid \gvCancel{E}
      \\
      &
      &\mid& \gvTry{E}{x}{M}{N}
      \\
      \text{Pure contexts}
      &\tm{P}
      &::= & \gvHole
             \mid \gvApp{P}{M}
             \mid \gvApp{V}{P}
             \mid \gvLetUnit{P}{M}
             \mid \gvPair{P}{M}
             \mid \gvPair{V}{P}
             \mid \gvLetPair{x}{y}{P}{M}
      \\
      &
      &\mid& \gvInl{P}
             \mid \gvInr{P}
             \mid \gvCaseSum{P}{x}{M}{y}{N}
      \\
      &
      &\mid& \gvFork{P}
             \mid \gvSend{P}{M}
             \mid \gvSend{V}{P}
             \mid \gvRecv{P}
             \mid \gvClose{P}
             \mid \gvCancel{P}
      \\
      \text{Thread contexts}
      &\tm{\gvConf{F}}
      &::= & \tm{\phi}\tm{E}
      \\
      \text{Configuration contexts}
      &\tm{\gvConf{G}}
      &::= & \gvHole
             \mid \gvRes{a}{\gvConf{G}}
             \mid \gvPPar{\gvConf{G}}{\gvConf{C}}
    \end{array}
    \)
  \end{mdframed}
  \caption{Exceptional GV, runtime syntax.}
  \label{fig:egv-runtime}
\end{figure*}

\begin{figure*}
    \begin{mdframed}
    {Term reduction}
    \[\!\!%
      \setlength{\arraycolsep}{4pt}%
      \begin{array}{llcl}
        \textsc{E-Lam}
        & {\gvApp{\gvAbs[A]{x}{M}}{V}}
        & \gvRedArrPure
        & {\gvSub{M}{x}{V}}
        \\
        \textsc{E-Unit}
        & {\gvLetUnit{\gvUnit}{M}}
        & \gvRedArrPure
        & {\tm{M}}
        \\
        \textsc{E-Pair}
        & {\gvLetPair{x}{y}{\gvPair{V}{W}}{M}}
        & \gvRedArrPure
        & {\gvSub{M}{\tm{x}\st{,}\;\tm{y}}{\tm{V}\st{,}\;\tm{W}}}
        \\
        \textsc{E-Inl}
        & {\gvCaseSum{\gvInl{V}}{x}{M}{y}{N}}
        & \gvRedArrPure
        & {\gvSub{M}{x}{V}}
        \\
        \textsc{E-Inr}
        & {\gvCaseSum{\gvInr{V}}{x}{M}{y}{N}}
        & \gvRedArrPure
        & {\gvSub{N}{y}{V}}
        \\
        \textsc{E-Val}
        & {\gvTry{V}{x}{M}{N}}
        & \gvRedArrPure
        & {\gvSub{M}{x}{V}}
        \\
        \textsc{E-Lift}
        & {\gvPlug{E}{M}}
        & \gvRedArrPure
        & {\gvPlug{E}{M'}}\st{,}
          \quad\text{if}\;\gvRedPure{M}{M'}
      \end{array}
    \]
    {Configuration equivalence}
    \[
      \gvPar{\gvConf{C}}{\gvPPar{\gvConf{D}}{\gvConf{E}}}
      \equiv
      \gvPar{\gvPPar{\gvConf{C}}{\gvConf{D}}}{\gvConf{E}}
      \qquad
      \gvPar{\gvConf{C}}{\gvConf{D}}
      \equiv
      \gvPar{\gvConf{D}}{\gvConf{C}}
      \qquad
      \gvRes{a}{\gvRes{b}{\gvConf{C}}}
      \equiv
      \gvRes{b}{\gvRes{a}{\gvConf{C}}}
    \]
    \[
      \gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}
      \equiv
      \gvBuf{b}{\gvVec{W}}{a}{\gvVec{V}}
      \qquad
      \gvPar{\gvConf{C}}{\gvRes{a}{\gvConf{D}}}
      \equiv
      \gvRes{a}{\gvPPar{\gvConf{C}}{\gvConf{D}}},
      \quad\text{if}\;\gvVar{a}\notin\text{fv}{(\gvConf{C})}
    \]
    {Configuration reduction}
    \[\!\!%
      \setlength{\arraycolsep}{4pt}%
      \begin{array}{llcl}
        \textsc{E-Fork}
        & \multicolumn{3}{l}{%
          {\gvPlug{\gvConf{F}}{\gvFork{\gvAbs[A]{x}{M}}}}
          \gvRedArr
          {\gvRes{a}{\gvRes{b}{\gvPPar{\gvPlug{\gvConf{F}}{a}}{%
          \gvPar{\gvChild{\gvSub{M}{b}{x}}}{\gvBuf{a}{\gvVecEmp}{b}{\gvVecEmp}}}}}},
          \quad\text{where \tm{a}, \tm{b} are fresh}}
        \\
        \textsc{E-Send}
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvSend{U}{a}}}{%
          \gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}}}
        & \gvRedArr
        & {\gvPar{\gvPlug{\gvConf{F}}{a}}{%
          \gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}\gvVecAdd\gvVar{U}}}}
        \\
        \textsc{E-Recv}
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvRecv{U}}}{%
          \gvBuf{a}{\gvVar{U}\gvVecAdd\gvVec{V}}{b}{\gvVec{W}}}}
        & \gvRedArr
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvPair{U}{a}}}{%
          \gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}}}
        \\
        \textsc{E-Close}
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvClose{a}}}{%
          \gvPar{\gvPlug{\gvConf{F'}}{\gvClose{b}}}{%
          \gvBuf{a}{\gvVecEmp}{b}{\gvVecEmp}}}}
        & \gvRedArr
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvUnit}}{%
          \gvPlug{\gvConf{F'}}{\gvUnit}}}
        \\
        \textsc{E-Cancel}
        & {\gvPlug{\gvConf{F}}{\gvCancel{a}}}
        & \gvRedArr
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvUnit}}{\gvZap{a}}}
        \\
        \textsc{E-Zap}
        & {\gvPar{\gvZap{a}}{\gvBuf{a}{\gvVar{U}\gvVecAdd\gvVec{V}}{b}{\gvVec{W}}}}
        & \gvRedArr
        & {\gvPar{\gvZap{a}}{\gvPar{\gvZap{U}}{\gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}}}}
        \\
        \textsc{E-CloseZap}
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvClose{a}}}{\gvPar{\gvZap{b}}{%
          \gvBuf{a}{\gvVecEmp}{b}{\gvVecEmp}}}}
        & \gvRedArr
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvRaise}}{\gvPar{\gvZap{a}}{%
          \gvPar{\gvZap{b}}{\gvBuf{a}{\gvVecEmp}{b}{\gvVecEmp}}}}}
        \\
        \textsc{E-RecvZap}
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvRecv{a}}}{\gvPar{\gvZap{b}}{%
          \gvBuf{a}{\gvVecEmp}{b}{\gvVec{W}}}}}
        & \gvRedArr
        & {\gvPar{\gvPlug{\gvConf{F}}{\gvRaise}}{\gvPar{\gvZap{a}}{%
          \gvPar{\gvZap{b}}{\gvBuf{a}{\gvVecEmp}{b}{\gvVec{W}}}}}}
        \\
        \textsc{E-Raise}
        & {\gvPlug{\gvConf{F}}{\gvTry{\gvPlug{P}{\gvRaise}}{x}{M}{N}}}
        & \gvRedArr
        & {\gvPar{\gvPlug{\gvConf{F}}{N}}{\gvZap{P}}}
        \\
        \textsc{E-RaiseChild}
        & {\gvChild{\gvPlug{P}{\gvRaise}}}
        & \gvRedArr
        & {\gvZap{P}}
        \\
        \textsc{E-RaiseMain}
        & {\gvMain{\gvPlug{P}{\gvRaise}}}
        & \gvRedArr
        & {\gvPar{\gvHalt}{\gvZap{P}}}
        \\
        \textsc{E-HaltChild}
        & {\gvPar{\gvConf{C}}{\gvChild{\gvUnit}}}
        & \gvRedArr
        & {\tm{\gvConf{C}}}
        \\
        \textsc{E-GC}
        & {\gvPar{\gvRes{a}{\gvRes{b}{\gvPPar{\gvZap{a}}{\gvPar{\gvZap{b}}{%
          \gvBuf{a}{\gvVecEmp}{b}{\gvVecEmp}}}}}}{\gvConf{C}}}
        & \gvRedArr
        & {\tm{\gvConf{C}}}
        \\
        \textsc{E-LiftC}
        & {\gvPlug{\gvConf{G}}{\gvConf{C}}}
        & \gvRedArr
        & {\gvPlug{\gvConf{G}}{\gvConf{D}}},
          \quad{\tm{\gvConf{C}}\gvRedArr\tm{\gvConf{D}}}
        \\
        \textsc{E-LiftM}
        & {\gvThread{\phi}{M}}
        & \gvRedArr
        & {\gvThread{\phi}{M'}},
          \quad{\gvThread{\phi}{M}\gvRedArrPure\gvThread{\phi}{M'}}
      \end{array} 
    \]
  \end{mdframed}
  \caption{Exceptional GV, reduction semantics.}
  \label{fig:egv-reduction}
\end{figure*}

\begin{figure*}
  \begin{mdframed}
    {Translation on types}
    \begin{gather*}
      \ftm{\gvTyUnit} = \rvTyUnit
      \quad
      \ftm{\gvTyFun{A}{B}} = \rvTyFun{\ftm{A}}{\rvTyOpt{\ftm{B}}}
      \quad
      \ftm{\gvTySum{A}{B}} = \rvTySum{\ftm{A}}{\ftm{B}}
      \quad
      \ftm{\gvTyPair{A}{B}} = \rvTyPair{\ftm{A}}{\ftm{B}}
      \\
      \ftm{\gvTySend{A}{S}} = \rvTySend{\ftm{A}}{\ftm{S}}
      \quad
      \ftm{\gvTyRecv{A}{S}} = \rvTyRecv{\ftm{A}}{\ftm{S}}
      \quad
      \ftm{\gvTyEnd} = \rvTyEnd
    \end{gather*}

    {Translation on terms}
    \[
    \begin{array}{lcl}
      \ftm{\gvVar{x}}
      & = & \rvSome{\rvVar{x}}
      \\
      \ftm{\gvVar{a}}
      & = & \rvSome{$\st{\rho}\st{(}\gvVar{a}\st{)}$}
      \\
      \ftm{\gvAbs[A]{x}{M}}
      & = & \rvSome{\rvAbs[\ftm{A}]{x}{\ftm{M}}}
      \\
      \ftm{\gvApp{M}{N}}
      & = & \rvTry{f}{\ftm{M}}{{\rvTry{x}{\ftm{N}}{\rvApp{f}{x}}}}
      \\
      \ftm{\gvUnit}
      & = & \rvSome{\rvUnit}
      \\
      \ftm{\gvLetUnit{M}{N}}
      & = & \rvTry{\rvUnit}{\ftm{M}}{{\ftm{N}}}
      \\
      \ftm{\gvPair{M}{N}}
      & = & \rvTry{x}{\ftm{M}}{{\rvTry{y}{\ftm{N}}{{\rvSome{\rvPair{x}{y}}}}}}
      \\
      \ftm{\gvLetPair{x}{y}{M}{N}}
      & = & \rvTry{\rvPair{x}{y}}{\ftm{M}}{\ftm{N}}
      \\
      \ftm{\gvInl{M}}
      & = & \rvTry{x}{\ftm{M}}{\rvSome{\rvInl{x}}}
      \\
      \ftm{\gvInr{M}}
      & = & \rvTry{x}{\ftm{M}}{\rvSome{\rvInr{x}}}
      \\
      \ftm{\gvCaseSum{L}{x}{M}{y}{N}}
      & = & \rvTry{z}{L}{{\rvCaseSum{z}{x}{\ftm{M}}{y}{\ftm{N}}}}
      \\
      \ftm{\gvCancel{M}}
      & = & \rvSome{\rvUnit}
      \\
      \ftm{\gvTry{L}{x}{M}{N}}
      & = & \rvCaseOpt{\ftm{L}}{x}{\ftm{M}}{\ftm{N}}
      \\
      \ftm{\gvRaise}
      & = & \rvNone
      \\
      \ftm{\gvFork{M}}
      & = & \rvSome{\rvFork{\ftm{M}}}
      \\
      \ftm{\gvSend{M}{N}}
      & = & \rvTry{x}{\ftm{M}}{{\rvTry{y}{\ftm{N}}{\rvSome{\rvSend{x}{y}}}}}
      \\
      \ftm{\gvRecv{M}}
      & = & \rvTry{x}{\ftm{M}}{{\rvRecv{x}}}
      \\
      \ftm{\gvClose{M}}
      & = & \rvSome{\rvClose{M}}
    \end{array}
    \]

    {Translation on configurations}
    \[
      \ftm{\tm{C}} = \rvRedTup[{\ftmc{C}}]{\ftmh{C}}{},
      \quad\text{where} \; \rho = \ren{\tm{C}} \; \text{and} \; \zeta = \zap{\tm{C}}
    \]
    \[
      \setlength{\arraycolsep}{2pt}%
      \begin{array}{lcllcllcl}
        \ren{\gvThread{\phi}{M}} & = & \varnothing
        & \quad \ren{\gvRes{a}{C}} & = & \ren{\tm{C}}
        & \quad \ren{\,\gvPPar{C}{D}} & = & \ren{\tm{C}} \cup \ren{\tm{D}}
        \\
        \ren{\gvHalt} & = & \varnothing
        & \quad \ren{\gvZap{a}} & = & \varnothing
        & \quad \ren{\gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}} & = & \{ \tm{a}\mapsto\tm{a},\tm{b}\mapsto\tm{a}\}
        \vspace*{1ex}
        \\
        \zap{\gvThread{\phi}{M}} & = & \varnothing
        & \quad \zap{\gvRes{a}{C}} & = & \zap{\tm{C}}
        & \quad \zap{\gvPPar{C}{D}} & = & \zap{\tm{C}} \cup \zap{\tm{D}}
        \\
        \zap{\gvHalt} & = & \varnothing
        & \quad \zap{\gvZap{a}} & = & \{\rho(\gvVar{a})\}
        & \quad \zap{\gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}} & = & \varnothing
        \vspace*{2ex}
        \\
        \ftmc{\gvThread{\phi}{M}}
        & = & \{\rvThread{\phi}{\ftm{M}}\}
        & \quad \ftmc{\gvRes{a}{C}}
        & = & \ftmc{\tm{C}}
        & \quad \ftmc{\gvPar{C}{D}}
        & = & \ftmc{\tm{C}}\cup\ftmc{\tm{D}}
        \\
        \ftmc{\gvHalt}
        & = & \{\rvPanic\}
        & \quad \ftmc{\gvZap{a}}
        & = & \varnothing
        & \quad \ftmc{\gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}}
        & = & \varnothing
        \vspace*{1ex}
        \\
        \ftmh{\gvThread{\phi}{M}}
        & = & \varnothing
        & \quad \ftmh{\gvRes{a}{C}}
        & = & \ftmh{\tm{C}}
        & \quad \ftmh{\gvPar{C}{D}}
        & = & \ftmh{\tm{C}}\cup\ftmh{\tm{D}}
        \\
        \ftmh{\gvHalt}
        & = & \varnothing
        & \quad \ftmh{\gvZap{a}}
        & = & \varnothing
        & \quad \ftmh{\gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}}
        & = & \rvHeap{H}(\rho(\gvVar{a}), \gvVec{V}\gvVecAdd\gvVec{W})
      \end{array}
    \]
    \vspace*{0.5ex}
    \[
      \begin{array}{lcll}
        \rvHeap{H}(\gvVar{a}, \gvVecEmp)
        & = & \{\rho(\gvVar{a}) \mapsto \rvMemEmp\},
        & \text{if} \; \gvVar{a} \notin \zeta
        \\
        \rvHeap{H}(\gvVar{a}, \gvVar{U}\gvVecAdd\gvVec{V})
        & = & \{\rho(\gvVar{a}) \mapsto \rvMemData{U}{b}\} \cup \rvHeap{H}(\gvVar{b}, \gvVec{V}),
        & \text{if} \; \gvVar{a} \notin \zeta,
          \text{where} \; \gvVar{b} \; \text{is fresh}
        \\
        \rvHeap{H}(\gvVar{a}, \gvVec{V})
        & = & \{\rho(\gvVar{a}) \mapsto \rvMemDisc\},
        & \text{if} \; \gvVar{a} \in \zeta
      \end{array}
    \]
  \end{mdframed}
  \caption%
  [Translation EGV to RV.]%
  {Translation from Exceptional GV to Rusty Variation.}
  \label{fig:egv2rv}
\end{figure*}

\begin{lemma}\label{lem:translate-term}
  If $\tm{M}\gvRedArrPure\tm{M'}$,
  then $\tm{\ftm{M}}\gvRedArrPure\tm{\ftm{M}}$.
\end{lemma}
\begin{proof}
  By induction on the reduction.
\end{proof}

\begin{lemma}
  If $\tm{\ftm{M}}\gvRedArrPure\tm{N}$,
  then there exists a term $\tm{M'}$ such that
  $\tm{M}\gvRedArrPure\tm{M'}$ and
  $\tm{N}\gvRedArrPure\tm{\ftm{M'}}$.
\end{lemma}
\begin{proof}
  By induction on the reduction.
\end{proof}

\begin{lemma}\label{lem:translate-raise}
  $\ftm{\gvPlug{P}{\gvRaise}}\gvRedArrPure^{\star}\rvNone$
\end{lemma}
\begin{proof}
  By induction on $\tm{P}$. Apply \textsc{E-None}.
\end{proof}

\begin{theorem}
  If $\tm{\gvConf{C}}$ is well-typed and $\tm{\gvConf{C}}\gvRedArr\tm{\gvConf{C'}}$,
  then \\ $\tm{\ftm{\gvConf{C}}}\gvRedArr^{+}\tm{\ftm{\gvConf{C'}}}$.
\end{theorem}
\begin{proof}
  By case analysis on the reduction.
  We handle applications of \textsc{E-LiftC} in each case as a prefix $\tm{\gvConf{G}}$.
  \begin{itemize}
  \item
    Case \textsc{E-Cancel}.
    We have $\tm{\gvConf{C}} = \gvPlug{\gvConf{G}}{\gvPlug{\gvConf{F}}{\gvCancel{a}}}$. As $\tm{\gvConf{C}}$ is well-typed, $\gvVar{a}$ does not occur in $\tm{\gvConf{G}}$ or $\tm{\gvConf{F}}$, and $\ren{\gvConf{C}}(\gvVar{a})$ occurs at most once in $\ftm{\gvConf{C}}$, \ie $\ftmArc{a}{\gvConf{C}}\le{1}$. \\
    Apply \textsc{E-Zap}.
  \item
    Case \textsc{E-Zap}.
    We have $\tm{\gvConf{C}} = \gvPlug{\gvConf{G}}{\gvPar{\gvZap{a}}{\gvBuf{a}{\gvVar{U}\gvVecAdd\gvVec{V}}{b}{\gvVec{W}}}}$. For each channel $\gvVar{c}$ in $\gvVar{U}$: As $\tm{\gvConf{C}}$ is well-typed, $\gvVar{c}$ does not occur in $\gvConf{G}$, $\ren{\gvConf{C}}(\gvVar{c})$ occurs at most once in $\ftm{\gvConf{G}}$, \ie $\ftmArc{c}{\gvConf{C}}\le{1}$. Apply \textsc{E-Zap}.
  \item
    Case \textsc{E-Raise}.
    We have \\
    $\tm{\gvConf{C}} = \gvPlug{\gvConf{G}}{\gvPlug{\gvConf{F}}{\gvTry{\gvPlug{P}{\gvRaise}}{x}{M}{N}}}$. \\
    Apply \cref{lem:translate-raise} and \textsc{E-None}. \\
    For each channel $\gvVar{c}$ in $\gvVar{P}$: As $\tm{\gvConf{C}}$ is well-typed, $\gvVar{c}$ does not occur in $\gvConf{G}$, and $\ren{\gvConf{C}}(\gvVar{c})$ occurs at most once in $\ftm{\gvConf{G}}$, \ie $\ftmArc{c}{\gvConf{C}}\le{1}$. Apply \textsc{E-Zap}.
  \item
    Case \textsc{E-RaiseChild}.
    We have
    $\tm{\gvConf{C}} = \gvPlug{\gvConf{G}}{\gvChild{\gvPlug{P}{\gvRaise}}}$. \\
    Apply \cref{lem:translate-raise} and \textsc{E-HaltChild}.
  \item
    Case \textsc{E-RaiseMain}.
    We have
    $\tm{\gvConf{C}} = \gvPlug{\gvConf{G}}{\gvMain{\gvPlug{P}{\gvRaise}}}$. \\
    Apply \cref{lem:translate-raise} and \textsc{E-HaltMain}.
  \item
    Case \textsc{E-GC}.
    We have \\
    $\tm{\gvConf{C}} = \gvPlug{\gvConf{G}}{\gvPar{\gvRes{a}{\gvRes{b}{\gvPPar{\gvZap{a}}{\gvPar{\gvZap{b}}{\gvBuf{a}{\gvVecEmp}{b}{\gvVecEmp}}}}}}{\gvConf{C}}}$. \\
    As $\tm{\gvConf{C}}$ is well-typed, $\gvVar{a}$ and $\gvVar{b}$ do not occur in $\gvConf{G}$, and $\ren{\gvConf{C}}(\gvVar{a})$ does not occur in $\ftm{\gvConf{G}}$, \ie $\ftmArc{a}{\gvConf{C}}=0$. \\
    Apply \textsc{E-GC}.
  \item
    Case \textsc{E-LiftM}.
    Apply \cref{lem:translate-term} and \textsc{E-LiftM}.
  \end{itemize}
  In the remaining cases, apply the rule of the same name.
\end{proof}

\begin{theorem}
  If $\tm{\ftm{\gvConf{C}}}\gvRedArr\tm{\gvConf{D}}$,
  then there exists a term $\tm{\gvConf{C'}}$ such that
  $\tm{\gvConf{C}}\equiv\gvRedArr^{+}\tm{\gvConf{C'}}$ and
  $\tm{\gvConf{D}}\gvRedArr^{\star}\tm{\ftm{\gvConf{C'}}}$. 
\end{theorem}
\begin{proof}
  By case analysis on the reduction.
  \begin{itemize}
  \item
    Case \textsc{E-Zap}. There must be a channel $\gvVar{a}$ for which $\ftmArc{a}{\gvConf{C}}\le{1}$. There are two cases:
    \begin{itemize}
    \item 
      Case $\gvConf{C}\equiv\gvPlug{\gvConf{G}}{\gvPlug{\gvConf{F}}{\gvCancel{a}}}$. Let $\gvConf{C'}=\gvPlug{\gvConf{G}}{\gvPar{\gvPlug{\gvConf{F}}{\gvUnit}}{\gvZap{a}}}$. \\ For $\gvConf{C}\equiv\gvRedArr\gvConf{C'}$: Apply \textsc{E-Cancel}. \\ For $\rvConf{D}\rvRedArr^{\star}\ftm{\gvConf{C'}}$: Apply reflexivity.
    \item
      Case $\gvConf{C}\equiv\gvPlug{\gvConf{G}}{\gvPar{\gvZap{a}}{\gvBuf{a}{\gvVar{U}\gvVecAdd\gvVec{V}}{b}{\gvVec{W}}}}$. \\ Let $\gvConf{C'} = \gvPlug{\gvConf{G}}{\gvPar{\gvZap{a}}{\gvPar{\gvZap{U}}{\gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}}}}$. \\ For $\gvConf{C}\equiv\gvRedArr\gvConf{C'}$: Apply \textsc{E-Zap}. \\ For $\rvConf{D}\rvRedArr^{\star}\ftm{\gvConf{C'}}$: For each channel $\gvVar{c}$ in $\gvVar{U}$: $\tm{\gvConf{C'}}$ is well-typed, by subject reduction, and hence $\gvVar{c}$ does not occur in $\gvConf{G}$, and $\ren{\gvConf{C'}}(\gvVar{c})$ occurs at most once in $\ftm{\gvConf{G}}$, \ie $\ftmArc{c}{\gvConf{C}}\le{1}$. Apply \textsc{E-Zap}.
    \end{itemize}
  \item
    Case \textsc{E-GC}. We have $\ftmArc{a}{\gvConf{C}}=0$. Therefore, there must be two channels $\tm{a}$ and $\tm{b}$ which are cancelled, \ie $\gvConf{C}\equiv\gvPlug{\gvConf{G}}{\gvRes{a}{\gvRes{b}{\gvPar{\gvPPar{\gvZap{a}}{\gvPar{\gvZap{b}}{\gvBuf{a}{\gvVec{V}}{b}{\gvVec{W}}}}}{\gvConf{E}}}}}$. \\ Let $\gvConf{C'}=\gvPlug{\gvConf{G}}{\gvConf{E}}$. \\
    For $\gvConf{C}\equiv\gvRedArr\gvConf{C'}$: Apply \textsc{E-Zap} repeatedly. Apply \textsc{E-GC}. \\
    For $\rvConf{D}\gvRedArr^{\star}\ftm{\gvConf{C'}}$: Apply reflexivity.
  \item
    Case \textsc{E-HaltChild}.
    There are two cases:
    \begin{itemize}
    \item
      Case $\gvConf{C}\equiv\gvPlug{\gvConf{G}}{\gvPar{\gvConf{E}}{\gvChild{\gvUnit}}}$. Let $\gvConf{C'}=\gvPlug{\gvConf{G}}{\gvConf{E}}$. \\ For $\gvConf{C}\equiv\gvRedArr\gvConf{C'}$: Apply \textsc{E-HaltChild}. \\ For $\rvConf{D}\rvRedArr\ftm{\gvConf{C'}}$: Apply reflexivity.
    \item
      Case $\gvConf{C}\equiv\gvPlug{\gvConf{G}}{\gvPar{\gvConf{E}}{\gvChild{\gvRaise}}}$. Let $\gvConf{C'}=\gvPlug{\gvConf{G}}{\gvConf{E}}$. \\ For $\gvConf{C}\equiv\gvRedArr\gvConf{C'}$: Apply \textsc{E-RaiseChild}. \\ For $\rvConf{D}\rvRedArr\ftm{\gvConf{C'}}$: Apply reflexivity.
    \end{itemize}
  \end{itemize}
\end{proof}

\end{document}
